<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RecogitoJS 3</title>
    <style>
      *, *:before, *:after {
        box-sizing: border-box;
      }

      html, body {
        background: #e2e2e2;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: row;
        justify-content: center;
      }

      #container {
        max-width: 800px;
        background-color: #fff;
        padding: 40px;
        border-style: solid;
        border-color: #cfcfcf;
        border-width: 0 1px;
      }

      #content .not-annotatable {
        color: dimgray;
        border: 3px solid wheat;
      }

      h1 {
        margin: 0;
        padding: 0 0 20px 0;
      }

      p {
        font-size: 17px;
        line-height: 160%;
      }

      .footnote-ref-tail {
        white-space: nowrap;
      }

      .footnote-ref {
        display: inline-block;
        min-width: 20px;
        background-clip: content-box;
        vertical-align: super;
        color: #5f01df;
        font-size: 14px;
        font-style: normal;
        font-weight: bold;
        line-height: 17px;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        position: relative;
        top: 5px;
      }

      .footnote-ref::before {
        content: '[';
      }

      .footnote-ref::after {
        content: ']';
      }

      #buttons {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1;
      }

      #debug {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        text-align: right;
        background-color: rgba(0, 0, 0, 0.75);
      }

      #debug p {
        padding: 0;
        margin: 0;
        font-size: 0.8em;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <div id="buttons">
      <button id="filter">Toggle Filter</button>
      <button id="fake-presence">Fake Presence</button>
    </div>

    <div id="container">
      <p>
        This text is outside the annotatable container.
      </p>

      <div id="content">
        <h1>Homer: The Odyssey</h1>

        <p>
          Tell me, O muse, of that ingenious
          <span class="footnote-ref-tail">hero.<a
            class="footnote-ref"
            name="footnote-ref-1"
            href="#footnote-1"
            >1</a></span> who travelled far and wide after he had sacked the famous town of Troy.
          Many cities did he visit, and many were the nations with whose manners and customs he was acquainted; moreover
          he suffered much by sea while trying to save his own life and bring his men safely home; but do what he might he
          could not save his men, for they perished through their own sheer folly in eating the cattle of the Sun-god
          Hyperion; so the god prevented them from ever reaching home. Tell me, too, about all these things, O daughter of
          Jove, from whatsoever source you may know them.
        </p>

        <h5 class="not-annotatable">
          Parent not annotabtale!
          <span>And its sub-element</span>
        </h5>

        <p>
          So now all who escaped death in battle or by shipwreck had got safely home except Ulysses, and he, though he was
          longing to return to his wife and country, was detained by the goddess Calypso, who had got him into a large
          cave and wanted to marry him. But as years went by, there came a time when the gods settled that he should go
          back to Ithaca; even then, however, when he was among his own people, his troubles were not yet over;
          nevertheless all the gods had now begun to pity him except Neptune, who still persecuted him without ceasing and
          would not let him get home.
        </p>

        <h5>
          Parent annotatable!
          <span class="not-annotatable">But its sub-element is not!</span>
        </h5>

        <p>
          Now Neptune had gone off to the Ethiopians, who are at the world's end, and lie in two halves, the one looking
          West and the other East. He had gone there to accept a hecatomb of sheep and oxen, and was enjoying himself at
          his festival; but the other gods met in the house of Olympian Jove, and the sire of gods and men spoke first. At
          that moment he was thinking of Aegisthus, who had been killed by Agamemnon's son Orestes; so he said to the
          other gods:
        </p>

        <div class="not-annotatable">
          <h3>Not annotatable block!</h3>
          <p>
            "See now, how men lay blame upon us gods for what is after all nothing but their own folly. Look at Aegisthus;
            he must needs make love to Agamemnon's wife unrighteously and then kill Agamemnon, though he knew it would be
            the <span class="not-annotatable">death of him; for I sent Mercury to warn him not</span> to do either of these
            things, inasmuch as Orestes would be
            sure to take his revenge when he grew up and wanted to return home. Mercury told him this in all good will but
            he would not listen, and now he has paid for everything in full."
          </p>
        </div>

        <p>
          Then Minerva said, "Father, son of Saturn, King of kings, it served Aegisthus right, and so it would any one
          else who does as he did; but Aegisthus is neither here nor there; it is for Ulysses that my heart bleeds, when I
          think of his sufferings in that lonely sea-girt island, far away, poor man, from all his friends. It is an
          island covered with forest, in the very middle of the sea, and a goddess lives there, daughter of the magician
          Atlas, who looks after the bottom of the ocean, and carries the great columns that keep heaven and earth
          asunder. This daughter of Atlas has got hold of poor unhappy Ulysses, and keeps trying by every kind of
          blandishment to make him forget his home, so that he is tired of life, and thinks of nothing but how he may once
          more see the smoke of his own chimneys. You, sir, take no heed of this, and yet when Ulysses was before Troy did
          he not propitiate you with many a burnt sacrifice? Why then should you keep on being so angry with him?"
        </p>

        <p>
          And Jove said, "My child, what are you talking about? How can I forget Ulysses than whom there is no more
          capable man on earth, nor more liberal in his offerings to the immortal gods that live in heaven? Bear in mind,
          however, that Neptune is still furious with Ulysses for having blinded an eye of Polyphemus king of the
          Cyclopes. Polyphemus is son to Neptune by the nymph Thoosa, daughter to the sea-king Phorcys; therefore though
          he will not kill Ulysses outright, he torments him by preventing him from getting home. Still, let us lay our
          heads together and see how we can help him to return; Neptune will then be pacified, for if we are all of a mind
          he can hardly stand out against us."
        </p>

        <p>
          And Minerva said, "Father, son of Saturn, King of kings, if, then, the gods now mean that Ulysses should get
          home, we should first send Mercury to the Ogygian island to tell Calypso that we have made up our minds and that
          he is to return. In the meantime I will go to Ithaca, to put heart into Ulysses' son Telemachus; I will embolden
          him to call the Achaeans in assembly, and speak out to the suitors of his mother Penelope, who persist in eating
          up any number of his sheep and oxen; I will also conduct him to Sparta and to Pylos, to see if he can hear
          anything about the return of his dear father- for this will make people speak well of him."
        </p>

        <p>
          Tell me, O muse, of that ingenious hero who travelled far and wide after he had sacked the famous town of Troy.
          Many cities did he visit, and many were the nations with whose manners and customs he was acquainted; moreover
          he suffered much by sea while trying to save his own life and bring his men safely home; but do what he might he
          could not save his men, for they perished through their own sheer folly in eating the cattle of the Sun-god
          Hyperion; so the god prevented them from ever reaching home. Tell me, too, about all these things, O daughter of
          Jove, from whatsoever source you may know them.
        </p>

        <p>
          So now all who escaped death in battle or by shipwreck had got safely home except Ulysses, and he, though he was
          longing to return to his wife and country, was detained by the goddess Calypso, who had got him into a large
          cave and wanted to marry him. But as years went by, there came a time when the gods settled that he should go
          back to Ithaca; even then, however, when he was among his own people, his troubles were not yet over;
          nevertheless all the gods had now begun to pity him except Neptune, who still persecuted him without ceasing and
          would not let him get home.
        </p>

        <p>
          Now Neptune had gone off to the Ethiopians, who are at the world's end, and lie in two halves, the one looking
          West and the other East. He had gone there to accept a hecatomb of sheep and oxen, and was enjoying himself at
          his festival; but the other gods met in the house of Olympian Jove, and the sire of gods and men spoke first. At
          that moment he was thinking of Aegisthus, who had been killed by Agamemnon's son Orestes; so he said to the
          other gods:
        </p>

        <p>
          "See now, how men lay blame upon us gods for what is after all nothing but their own folly. Look at Aegisthus;
          he must needs make love to Agamemnon's wife unrighteously and then kill Agamemnon, though he knew it would be
          the death of him; for I sent Mercury to warn him not to do either of these things, inasmuch as Orestes would be
          sure to take his revenge when he grew up and wanted to return home. Mercury told him this in all good will but
          he would not listen, and now he has paid for everything in full."
        </p>

        <p>
          Then Minerva said, "Father, son of Saturn, King of kings, it served Aegisthus right, and so it would any one
          else who does as he did; but Aegisthus is neither here nor there; it is for Ulysses that my heart bleeds, when I
          think of his sufferings in that lonely sea-girt island, far away, poor man, from all his friends. It is an
          island covered with forest, in the very middle of the sea, and a goddess lives there, daughter of the magician
          Atlas, who looks after the bottom of the ocean, and carries the great columns that keep heaven and earth
          asunder. This daughter of Atlas has got hold of poor unhappy Ulysses, and keeps trying by every kind of
          blandishment to make him forget his home, so that he is tired of life, and thinks of nothing but how he may once
          more see the smoke of his own chimneys. You, sir, take no heed of this, and yet when Ulysses was before Troy did
          he not propitiate you with many a burnt sacrifice? Why then should you keep on being so angry with him?"
        </p>

        <p>
          And Jove said, "My child, what are you talking about? How can I forget Ulysses than whom there is no more
          capable man on earth, nor more liberal in his offerings to the immortal gods that live in heaven? Bear in mind,
          however, that Neptune is still furious with Ulysses for having blinded an eye of Polyphemus king of the
          Cyclopes. Polyphemus is son to Neptune by the nymph Thoosa, daughter to the sea-king Phorcys; therefore though
          he will not kill Ulysses outright, he torments him by preventing him from getting home. Still, let us lay our
          heads together and see how we can help him to return; Neptune will then be pacified, for if we are all of a mind
          he can hardly stand out against us."
        </p>

        <p>
          And Minerva said, "Father, son of Saturn, King of kings, if, then, the gods now mean that Ulysses should get
          home, we should first send Mercury to the Ogygian island to tell Calypso that we have made up our minds and that
          he is to return. In the meantime I will go to Ithaca, to put heart into Ulysses' son Telemachus; I will embolden
          him to call the Achaeans in assembly, and speak out to the suitors of his mother Penelope, who persist in eating
          up any number of his sheep and oxen; I will also conduct him to Sparta and to Pylos, to see if he can hear
          anything about the return of his dear father- for this will make people speak well of him."
        </p>

        <p>
          Tell me, O muse, of that ingenious hero who travelled far and wide after he had sacked the famous town of Troy.
          Many cities did he visit, and many were the nations with whose manners and customs he was acquainted; moreover
          he suffered much by sea while trying to save his own life and bring his men safely home; but do what he might he
          could not save his men, for they perished through their own sheer folly in eating the cattle of the Sun-god
          Hyperion; so the god prevented them from ever reaching home. Tell me, too, about all these things, O daughter of
          Jove, from whatsoever source you may know them.
        </p>

        <p>
          So now all who escaped death in battle or by shipwreck had got safely home except Ulysses, and he, though he was
          longing to return to his wife and country, was detained by the goddess Calypso, who had got him into a large
          cave and wanted to marry him. But as years went by, there came a time when the gods settled that he should go
          back to Ithaca; even then, however, when he was among his own people, his troubles were not yet over;
          nevertheless all the gods had now begun to pity him except Neptune, who still persecuted him without ceasing and
          would not let him get home.
        </p>

        <p>
          Now Neptune had gone off to the Ethiopians, who are at the world's end, and lie in two halves, the one looking
          West and the other East. He had gone there to accept a hecatomb of sheep and oxen, and was enjoying himself at
          his festival; but the other gods met in the house of Olympian Jove, and the sire of gods and men spoke first. At
          that moment he was thinking of Aegisthus, who had been killed by Agamemnon's son Orestes; so he said to the
          other gods:
        </p>

        <p>
          "See now, how men lay blame upon us gods for what is after all nothing but their own folly. Look at Aegisthus;
          he must needs make love to Agamemnon's wife unrighteously and then kill Agamemnon, though he knew it would be
          the death of him; for I sent Mercury to warn him not to do either of these things, inasmuch as Orestes would be
          sure to take his revenge when he grew up and wanted to return home. Mercury told him this in all good will but
          he would not listen, and now he has paid for everything in full."
        </p>

        <p>
          Then Minerva said, "Father, son of Saturn, King of kings, it served Aegisthus right, and so it would any one
          else who does as he did; but Aegisthus is neither here nor there; it is for Ulysses that my heart bleeds, when I
          think of his sufferings in that lonely sea-girt island, far away, poor man, from all his friends. It is an
          island covered with forest, in the very middle of the sea, and a goddess lives there, daughter of the magician
          Atlas, who looks after the bottom of the ocean, and carries the great columns that keep heaven and earth
          asunder. This daughter of Atlas has got hold of poor unhappy Ulysses, and keeps trying by every kind of
          blandishment to make him forget his home, so that he is tired of life, and thinks of nothing but how he may once
          more see the smoke of his own chimneys. You, sir, take no heed of this, and yet when Ulysses was before Troy did
          he not propitiate you with many a burnt sacrifice? Why then should you keep on being so angry with him?"
        </p>

        <p>
          And Jove said, "My child, what are you talking about? How can I forget Ulysses than whom there is no more
          capable man on earth, nor more liberal in his offerings to the immortal gods that live in heaven? Bear in mind,
          however, that Neptune is still furious with Ulysses for having blinded an eye of Polyphemus king of the
          Cyclopes. Polyphemus is son to Neptune by the nymph Thoosa, daughter to the sea-king Phorcys; therefore though
          he will not kill Ulysses outright, he torments him by preventing him from getting home. Still, let us lay our
          heads together and see how we can help him to return; Neptune will then be pacified, for if we are all of a mind
          he can hardly stand out against us."
        </p>

        <p>
          And Minerva said, "Father, son of Saturn, King of kings, if, then, the gods now mean that Ulysses should get
          home, we should first send Mercury to the Ogygian island to tell Calypso that we have made up our minds and that
          he is to return. In the meantime I will go to Ithaca, to put heart into Ulysses' son Telemachus; I will embolden
          him to call the Achaeans in assembly, and speak out to the suitors of his mother Penelope, who persist in eating
          up any number of his sheep and oxen; I will also conduct him to Sparta and to Pylos, to see if he can hear
          anything about the return of his dear father- for this will make people speak well of him."
        </p>
      </div>
    </div>

    <script type="module">
      import { createTextAnnotator, W3CTextFormat } from '../src/index.ts';

      window.onload = async () => {
        var contentContainer = document.getElementById('content');

        const style = ((annotation, state, z) =>
          ({
            fill: '#00b1ff',
            fillOpacity: (state.hovered || state.selected) ? 0.5 : 0.15,
            underlineColor: 'oklch(0.72 0.19 232.06)',
            underlineOffset: (z * 3.5) || 0,
            underlineThickness: 2
          }));

        var r = createTextAnnotator(contentContainer, {
          // adapter: W3CTextFormat('https://www.gutenberg.org', contentContainer),
          allowModifierSelect: true,
          renderer: 'SPANS',
          // annotatingEnabled: false,
          // selectionMode: 'all',
          style
        });

        var annotations;

        // r.loadAnnotations('annotations.w3c.json').then(a => annotations = a);

        r.on('createAnnotation', annotation => {
          console.log('createAnnotation', annotation);
        });

        r.on('updateAnnotation', (annotation, previous) => {
          console.log('updateAnnotation', annotation, previous);
        });

        r.on('deleteAnnotation', (annotation) => {
          console.log('deleteAnnotation', annotation);
        });

        r.on('clickAnnotation', (annotations) => {
          console.log('clicked', annotations);
        })

        r.on('selectionChanged', (annotations) => {
          console.log('selectionChanged', annotations);
        });

        r.on('viewportIntersect', (annotations) => {
          console.log('viewport', annotations);
        });

        var filterActive = false;

        var toggleButton = document.getElementById('filter');
        var toggleButtonLabel = toggleButton.innerText;

        toggleButton.addEventListener('click', function () {
          if (filterActive) {
            r.setFilter(undefined);

            filterActive = false;
            toggleButton.innerText = `${toggleButtonLabel} on`;
          } else {
            // Dummy filter - just filter randomly
            r.setFilter(a => {
              return (
                a.id !== '9b6aa528-660a-4551-8265-66f45c61acab' &&
                a.id !== '45d77d69-b9c9-419e-b6f3-672222bb3a23'
              );
            });

            filterActive = true;
            toggleButton.innerText = `${toggleButtonLabel} off`;
          }
        });

        // Just a hack for testing...
        var remoteSelection;

        var handlers = [];

        var presenceProvider = {
          on: function (event, callback) {
            handlers.push(callback);
          }
        };

        r.setPresenceProvider(presenceProvider);

        const fakeCollaborator = {
          presenceKey: '1',
          appearance: {
            label: 'Rainer',
            color: '#00cc00'
          }
        };

        var presenceButton = document.getElementById('fake-presence');

        presenceButton.addEventListener('click', function () {
          if (remoteSelection) {
            remoteSelection = undefined;

            handlers.forEach(callback => {
              callback(fakeCollaborator, []);
            });
          } else {
            const randomIdx = Math.floor(Math.random() * annotations.length);
            remoteSelection = annotations[randomIdx].id;

            handlers.forEach(callback => {
              callback(fakeCollaborator, [remoteSelection]);
            });
          }
        });

        // Make global so we can manipulate from the console
        window.r = r;
      };
    </script>
  </body>
</html>
