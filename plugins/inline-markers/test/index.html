<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inline Markers Plugin</title>
    <style>
      *, *:before, *:after {
        box-sizing: border-box;
      }

      html, body {
        background: #e2e2e2;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: row;
        justify-content: center;
      }

      #container {
        max-width: 800px;
        min-height: 100vh;
        background-color: #fff;
        padding: 40px;
        border-style: solid;
        border-color: #cfcfcf;
        border-width: 0 1px;
      }

      h1 {
        margin: 0;
        padding: 0 0 20px 0;
      }

      p {
        font-size: 17px;
        line-height: 160%;
      }

      marker {
        padding-right: 2px;
        pointer-events: none;
      }

      marker > span:before {
        position:relative;
        border-right: 1.5px solid oklch(59% 0.136 62 / 0.8);
        color: oklch(59% 0.136 62);
        font-family: sans-serif;
        font-size: 12px;
        font-weight: 600;
        content: attr(data-count);
        padding-right: 2px;
        bottom: 1px;
      }

      #selection {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }

      #selection h2 {
        margin-top: 2rem;
        font-size: 1.1rem;
        font-weight: 500;
      }

      #selection li {
        padding: 0.25rem 0;
      }

      #selection .empty {
        color: #727272;
        font-size: 0.875rem;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <div id="content">
        <h1>Homer: The Odyssey</h1>
        <p>
          Tell me, O muse, of that ingenious hero who travelled far and wide after he had sacked the famous town of Troy.
          Many cities did he visit, and many were the nations with whose manners and customs he was acquainted; moreover
          he suffered much by sea while trying to save his own life and bring his men safely home; but do what he might he
          could not save his men, for they perished through their own sheer folly in eating the cattle of the Sun-god
          Hyperion; so the god prevented them from ever reaching home. Tell me, too, about all these things, O daughter of
          Jove, from whatsoever source you may know them.
        </p>
      </div>

      <div id="selection">
        <h2>Selected:</h2>
        <div>
          <p class="empty">Click an annotation to select!</p>
        </div>
      </div>
    </div>


    <script type="module">
      import { createTextAnnotator, W3CTextFormat } from '@recogito/text-annotator';
      import { InlineMarkersRenderer } from '../src/index.ts';

      import '@recogito/text-annotator/text-annotator.css';

      const STYLE_NO_HOVER = {
        // fill: 'oklch(0.8 0.18 59.17 / 0.14)',
        fill: 'oklch(0.8 0.18 59.17 / 0.25)',
      };

      const STYLE_HOVER = (_, state, z) => {
        return state.hovered ? {
          // fill: 'oklch(0.8 0.18 59.17 / 0.7)',
          fill: 'oklch(0.87 0.12 66.96)',
          // fill: 'oklch(0.8 0.18 59.17 / 0.5)',
          // underlineColor: 'oklch(0.78 0.19 57.08 / 0.75)',
          // underlineThickness: 1.5,
          // underlineOffset: 3.5 * z
        } : {
          fill: '#bcbcbc40',
          // underlineColor: 'oklch(0.78 0.19 57.08 / 0.75)',
          // underlineThickness: 1.5,
          // underlineOffset: 3.5 * z
        }
      }

      window.onload = async () => {
        const contentContainer = document.getElementById('content');
        const r = createTextAnnotator(contentContainer, {
          // annotatingEnabled: false,
          mergeHighlights: {
            horizontalTolerance: 30
          },
          style: STYLE_NO_HOVER,
          renderer: InlineMarkersRenderer
        });

        // const plugin = mountPlugin(r);

        r.loadAnnotations('annotations.json');

        r.on('mouseEnterAnnotation', () => {
          r.setStyle(STYLE_HOVER);
        });

        r.on('mouseLeaveAnnotation', () => {
          r.setStyle(STYLE_NO_HOVER);
        });

        r.on('selectionChanged', sel => {
          if (sel.length > 0) {
            // Find all at this place
            const { start, end } = sel[0].target.selector[0];
            // console.log(start, end);

            const all = r.getAnnotations().filter(a => {
              const selector = a.target.selector[0];
              return selector.start === start && selector.end === end;
            });

            if (all.length > 0) {
              document.querySelector('#selection > div').innerHTML = 
                '<ul>' +
                all.map(a => `<li>${a.target.selector[0].quote}</li>`).join('') +
                '</ul>';
            } else {
              document.querySelector('#selection ul').innerHTML = 
                '<p class="empty">Click an annotation to select!</p>';
            }
          }
        });

        window.r = r;
      };
    </script>
  </body>
</html>